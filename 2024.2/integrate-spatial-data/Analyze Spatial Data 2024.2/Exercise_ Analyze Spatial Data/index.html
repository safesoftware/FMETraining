<h2 id="learning-objectives">Learning Objectives</h2>
<p>After completing this lesson, you&rsquo;ll be able to:</p>
<ul>
<li>Use the Bufferer to buffer your spatial data.</li>
<li>Use the Clipper to filter your spatial data.</li>
<li>Use the PointOnAreaOverlayer to conduct a point-to-polygon spatial join.</li>
<li>Use the PointOnRasterValueExtractor to conduct a point-to-raster overlay.</li>
<li>View the results of spatial analysis.</li>
</ul>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://s3.amazonaws.com/FMEData/FMEData/Workspaces/IntegrateSpatialData/exercise-analyze-spatial-data.fmw" target="_blank" rel="noreferrer noopener">Starting workspace</a>
<ul>
<li>C:\FMEData\Workspaces\IntegrateSpatialData\exercise-analyze-spatial-data.fmw</li>
</ul>
</li>
<li><a href="https://s3.amazonaws.com/FMEData/FMEData/Workspaces/IntegrateSpatialData/exercise-analyze-spatial-data-complete.fmw" target="_self">Complete workspace</a>
<ul>
<li>C:\FMEData\Workspaces\IntegrateSpatialData\exercise-analyze-spatial-data-complete.fmw</li>
</ul>
</li>
<li><a href="https://s3.amazonaws.com/FMEData/FMEData2022/Data/ElevationModel/DEM-Clipped.dem" target="_self">DEM-Clipped.dem</a>
<ul>
<li>C:\FMEData\Data\ElevationModel\DEM-Clipped.dem</li>
</ul>
</li>
<li><a href="https://s3.amazonaws.com/FMEData/FMEData2022/Data/Addresses/Addresses.gdb.zip" target="_self">Addresses.gdb.zip</a> (Esri Geodatabase)
<ul>
<li>C:\FMEData\Data\Addresses\Addresses.gdb.zip</li>
</ul>
</li>
<li><a href="https://s3.amazonaws.com/FMEData/FMEData2022/Data/Boundaries/LandBoundary.zip" target="_self">LandBoundary.zip</a> (Esri Shapefile)
<ul>
<li>C:\FMEData\Data\Boundaries\LandBoundary.zip</li>
</ul>
</li>
<li><a href="https://s3.amazonaws.com/FMEData/FMEData2022/Data/Boundaries/Coastline.zip" target="_self">Coastline.zip</a> (GML)
<ul>
<li>C:\FMEData\Data\Boundaries\Coastline.zip</li>
</ul>
</li>
</ul>
<h2 id="exercise">Exercise</h2>
<p>In this exercise, you will calculate the tsunami flood risk for all addresses in your city. You will model risk as a combination of closeness to the shoreline and elevation above sea level. Flood risk is on a scale from one to five (1-5), and you calculate it using this table:</p>
<table class="featureTable sort_table">
<tbody class="tbody">
<tr>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td colspan="3">Elevation (meters above sea level)</td>
</tr>
<tr>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>0-10m</td>
<td>10-25m</td>
<td>25-60m</td>
</tr>
<tr>
<td rowspan="3">Distance from Shoreline (meters)</td>
<td>100m</td>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>200m</td>
<td>2</td>
<td>3</td>
<td>4</td>
</tr>
<tr>
<td>300m</td>
<td>3</td>
<td>4</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>First, you have spatial elevation data (raster DEM), address points, land boundary polygon, and the coastline. You must use spatial analysis techniques on your starting datasets to calculate the flood risk. You have several steps in mind:</p>
<ul>
<li>Use a&nbsp;<strong>buffer&nbsp;</strong>to create three zones measuring the distance to the coastline: 0-100 m, 101-200 m, and 201-300 m.</li>
<li>Use&nbsp;<strong>spatial joining and overlaying</strong>&nbsp;to add an elevation and distance to the shoreline attribute to each address.</li>
<li>Use&nbsp;<strong>attributes&nbsp;</strong>to calculate the final flood risk.</li>
</ul>
<p>Let's get started!</p>
<h2 id="1-start-workbench">1) Start Workbench</h2>
<p>Open the&nbsp;<a href="https://s3.amazonaws.com/FMEData/FMEData/Workspaces/IntegrateSpatialData/exercise-analyze-spatial-data.fmw" target="_blank" rel="noreferrer noopener">starting workspace</a> in FME Workbench (2024.2 or later). &nbsp;This workspace contains the datasets you will be working with: a Digital Elevation Model (DEM) file for the elevation, an Esri ArcGIS Geodatabase for the addresses, an Esri shapefile of the land boundary, and a GML for the coastline. The DEM is an example of raster data, while the others are vector data.</p>
<p>Turn on feature caching and run the workspace. Inspect the results of each dataset to familiarize yourself with your data. You should notice that each dataset contains information we need for our final result. We'll combine them into the desired shape using spatial filtering and joining.</p>
<h2 id="2-create-bufferer-distance-attribute">2) Create Bufferer Distance Attribute</h2>
<p>We want to create a buffer zone for each distance band (100, 200, and 300 m). We could use three separate Bufferers, but there is a trick for improving your workflows in FME when you need to conduct multiple steps. Often, users want to use a <code>for</code> or <code>while</code> loop as you would in a programming language. However, you can accomplish most tasks in FME without using loops. One way is to use what we call <a href="https://community.safe.com/general-10/question-of-the-week-to-loop-or-not-to-loop-18238" target="_blank" rel="noopener">the Cloner-Loop technique</a>.</p>
<blockquote>
<p><img class="img mtm" role="presentation" src="images/safe_note.png" alt="Note" /></p>
<p><span style="font-family: inherit; font-size: 1em;">Looping is available via&nbsp;</span><a style="font-family: inherit; font-size: 1em; background-color: #ffffff;" href="https://docs.safe.com/fme/html/FME-Form-Documentation/FME-Form/Workbench/transformers_custom_looping.htm" target="_blank" rel="noopener">custom transformers</a><span style="font-family: inherit; font-size: 1em;">&nbsp;and the&nbsp;</span><a style="font-family: inherit; font-size: 1em; background-color: #ffffff;" href="https://docs.safe.com/fme/html/FME-Form-Documentation/FME-Transformers/Transformers/pythoncaller.htm" target="_blank" rel="noopener">PythonCaller</a><span style="font-family: inherit; font-size: 1em;">, but you do not need to use looping in FME workspaces in most cases.</span></p>
</blockquote>
<p>Add a Cloner connected to the Coastline feature type. Set Number of Copies to 3.&nbsp;</p>
<p><img class="image image-block image-center" src="images/1740685882852.png" alt="Setting Cloner parameters" width="861" height="253" /></p>
<p>The Cloner will create three copies of our coastline dataset, giving us three features instead of one. We will now give each feature a different value for the buffer, creating three buffer zones of different sizes without looping.</p>
<p>We will store the buffer distances in an attribute. Add an ExpressionEvaluator connected to the Cloner. Set Result to Distance. For the expression, enter&nbsp;<code>(@Value(_copynum) + 1) * 100</code>.&nbsp;</p>
<p><img class="image image-block image-center" src="images/1740685937708.png" alt="Calculating a new Distance attribute" width="434" height="459" /></p>
<p>Click&nbsp;<strong>OK</strong>. This expression will add one to the copy number from the Cloner (as counts from 0-2 instead of 1-3) and then multiply it by 100. The result is values of 100, 200, and 300, the buffer lengths we want. You can confirm this by clicking the ExpressionEvaluator, clicking Run To This, and inspecting the Distance attribute on the ExpressionEvaluator's Output cache.</p>
<p><img class="image image-block image-center" src="images/1740685996001.png" alt="Inspecting ExpressionEvaluator output" width="373" height="96" /></p>
<h2 id="3-add-bufferer">3) Add Bufferer</h2>
<p>Add a Bufferer after the ExpressionEvaluator. Set Buffer Distance to the Distance attribute.&nbsp;</p>
<p><img class="image image-block image-center" src="images/1740686034869.png" alt="Setting Bufferer parameters" width="377" height="289" /></p>
<p>Click&nbsp;<strong>OK</strong>&nbsp;and use Run To This on the Bufferer. Inspect the cache to confirm you have three buffer zones.</p>
<p><img class="image image-block image-center" src="images/1740686090589.png" alt="Inspecting Bufferer output" /></p>
<blockquote>
<p><img class="img mtm" role="presentation" src="images/safe_note.png" alt="Note" /></p>
<p><span style="font-family: inherit; font-size: 1em;">Some buffering scenarios require non-overlapping buffers. The Bufferer does not produce these, but if you want to create them quickly, the&nbsp;</span><a style="font-family: inherit; font-size: 1em; background-color: #ffffff;" href="https://hub.safe.com/publishers/safe-lab/transformers/multibufferer" target="_blank" rel="noreferrer noopener">MultiBufferer</a><span style="font-family: inherit; font-size: 1em;">&nbsp;custom transformer on the&nbsp;</span><a style="font-family: inherit; font-size: 1em; background-color: #ffffff;" href="https://hub.safe.com/" target="_blank" rel="noreferrer noopener">FME Hub</a><span style="font-family: inherit; font-size: 1em;"> can accomplish it. You can add it to a workspace by searching with Quick Add. Note, however, that sometimes you do not need to worry about overlaps. In the use case for this exercise, simply having the smaller buffers created on top of the larger ones ensures that the PointOnAreaOverlayer will only identify one distance for each point.</span></p>
</blockquote>
<h2 id="4-add-clipper">4) Add Clipper</h2>
<p>Next, we must adjust our buffer zones to only measure inland. Add a Clipper after the Bufferer. Connect the VancouverLandBoundary feature type to the Clipper port and the Buffered port to the Clippee port.</p>
<p><img class="image image-block image-center" src="images/1740686139687.png" alt="Adding and connecting a Clipper" width="1086" height="257" /></p>
<p>Run the Clipper and inspect the Clipper's Inside cache. The buffer zones from this port only cover the land area:</p>
<p><img class="image image-block image-center" src="images/1740686174133.png" alt="Inspecting the Clipper's Inside cache" width="461" height="244" /></p>
<h2 id="5-add-point-on-area-overlayer">5) Add PointOnAreaOverlayer</h2>
<p>We are ready to overlay the address points on the coastline buffer zones. Through this spatial join, we can add an attribute to our points that records which coastal distance band they overlap. Add a PointOnAreaOverlayer and connect the Clipper's Inside port to the Area port and the Postal Addresses feature type to the Points port.&nbsp;</p>
<p><img class="image image-block image-center" src="images/1740686296626.png" alt="Adding and connecting a PointOnAreaOverlayer" width="1262" height="399" /></p>
<p>Now, double-click the <strong>PointOnAreaOverlayer</strong>&nbsp;to edit its parameters. Expand the Attribute Accumulation section and enable the Merge Attributes parameter. With this parameter enabled, the PointOnAreaOverlayer adds attributes from the areas to the points.</p>
<p>Also, check the Generate List On Output 'Point' parameter. Set 'Point' List Name to DistanceList and choose Distance as the Selected Attribute.&nbsp;</p>
<p><img class="image image-block image-center" src="images/1740686385137.png" alt="Configuring PointOnAreaOverlayer" width="397" height="610" /></p>
<blockquote>
<p><img class="img mtm" role="presentation" src="images/safe_note.png" alt="Note" /></p>
<p><strong>⭐ New for FME 2025.0:&nbsp;</strong>we changed the terminology in several transformers. Accumulation Mode now refers to "Merge Overlaid" instead of "Merge Incoming," but the functionality is the same.</p>
</blockquote>
<blockquote>
<p><img class="img mtm" role="presentation" src="images/safe_note.png" alt="Note" /></p>
<p><span style="font-family: inherit; font-size: 1em;">Spatial analysis can get a bit tricky. With these settings, FME will generate a&nbsp;</span><a style="font-family: inherit; font-size: 1em; background-color: #ffffff;" href="https://docs.safe.com/fme/html/FME_Desktop_Documentation/FME_Desktop/!List_Attributes/About-List-Attributes.htm" target="_blank" rel="noreferrer noopener">list attribute</a><span style="font-family: inherit; font-size: 1em;"> for every area the point overlaps. Because the buffer polygons are not discrete (i.e., they overlap), some points overlap multiple buffer polygons. We could rely on feature order to correctly assign values to Distance, which would work properly in this case. However, relying on feature order in your workspaces is not good practice because it can change:</span></p>
<ul>
<li><span style="font-family: inherit; font-size: 1em;">if you change other parts of your workspace,</span></li>
<li><span style="font-family: inherit; font-size: 1em;">with transformer or reader upgrades, or</span></li>
<li><span style="font-family: inherit; font-size: 1em;">if the underlying data changes.</span></li>
</ul>
<p><span style="font-family: inherit; font-size: 1em;">It's often difficult to identify feature order problems, so it's best to avoid them first and make your workspace future-proof.</span></p>
<p><span style="font-family: inherit; font-size: 1em;">Therefore, in this scenario, we will use a more robust list-based method that will be more flexible if the underlying data changes.</span></p>
</blockquote>
<p>Click&nbsp;<strong>OK</strong>.</p>
<p>Run To This on the PointOnAreaOverlayer.</p>
<h2 id="6-add-list-transformers">6) Add List Transformers</h2>
<p>Now, we can use a few transformers to extract the closest distance from the new DistanceList attribute. First, let's confirm the structure of our list attribute. Inspect a feature in the PointOnAreaOverlayer's Point port near the coastline. You should see Distance has been assigned from the attribute merge, but you should also see there is now a DistanceList list attribute. This will contain one to three entries depending on the distance from the coastline. You can inspect the attribute in the Feature Information window:</p>
<p><img class="image image-block image-center" src="images/1660081718230.png" alt="DistanceList" /></p>
<p>We need to find the lowest value in DistanceList.Distance and set it to Distance. We can do that using a ListSorter and ListIndexer.</p>
<p>Add a ListSorter and connect it to the PointOnAreaOverlayer's Point port. Set List Attribute to DistanceList{}.Distance, Sort Type to Numeric, and Sort Order to Ascending. This will sort the list so the lowest entry is element 0.</p>
<p><img class="image image-block image-center" src="images/1740691379030.png" alt="ListSorter parameters" width="349" height="245" /></p>
<p>Click&nbsp;<strong>OK</strong>.</p>
<p>Add a ListIndexer and connect it to the ListSorter's Output port. Set List Attribute to DistanceList{} and List Index to Copy to 0. This will set the value of Distance to the lowest distance band of the feature.</p>
<p><img class="image image-block image-center" src="images/1740691413366.png" alt="ListIndexer parameters" width="349" height="273" /></p>
<p>Click&nbsp;<strong>OK</strong>.</p>
<p>Use Run to This on the ListIndexer. Inspect the results; you can see the Distance attribute on each point. Points not within 300 m of the shore will have &lt;missing&gt; values for Distance; let's fix that.</p>
<p><img class="image image-block image-center" src="images/1612306034205.png" alt="Inspecting Distance attribute on the PointOnAreaOverlayer output" /></p>
<h2 id="7-add-tester">7) Add Tester</h2>
<p>Let's remove the points that do not have a Distance value, leaving us with only the points in the buffered area. Add a Tester after the ListIndexer and configure it like this:</p>
<p><img class="image image-block image-center" src="images/1740691509775.png" alt="Tester configured to remove missing value points" width="420" height="348" /></p>
<p>Run your workspace and inspect the Tester's Passed cache. You should now have only points within the buffered zone.</p>
<p>This screenshot shows how the addresses fall within (and are assigned) zones, denoting their distance from the shoreline.</p>
<p><img class="image image-block image-center" src="images/Img1.211.Ex2.InitialDataProcessed.png" alt="Inspecting points falling inside buffer zones" /></p>
<blockquote>
<p><img class="img mtm" role="presentation" src="images/safe_note.png" alt="Note" /></p>
<p><span style="font-family: inherit; font-size: 1em;">You can inspect multiple caches, like in this screenshot, by Ctrl-clicking (⌘ Command-clicking on Mac) multiple caches.</span></p>
</blockquote>
<h2 id="8-add-point-on-raster-value-extractor">8) Add PointOnRasterValueExtractor</h2>
<p>The next step is to add an elevation attribute to each point using a&nbsp;<a href="https://docs.safe.com/fme/html/FME-Form-Documentation/FME-Transformers/Transformers/pointonrastervalueextractor.htm" target="_blank" rel="noopener">PointOnRasterValueExtractor</a>. This transformer is similar to the PointOnAreaOverlayer but takes raster data as input instead of vector areas. Add a PointOnRasterValueExtractor to the right side of your canvas. Connect the existing Reprojector's Reprojected port to the Raster input port and the Tester's Passed port to the Point input port. This section of your workspace should look like this:</p>
<p><img class="image image-block image-center" src="images/1740691611858.png" alt="Added PointOnRasterValueExtractor" width="1065" height="344" /></p>
<h2 id="9-add-attribute-renamer">9) Add AttributeRenamer</h2>
<p>This transformer will output an elevation value on our address points. However, because raster data can have multiple bands, you will not immediately see an Elevation attribute. A list called _band stores the elevation value. We can turn this list value into an exposed attribute with an AttributeRenamer. Add one connected to the PointOnRasterValueExtractor and open its parameters. For Input Attribute, enter <code>_band{0}.value;</code> for Output Attribute, enter Elevation.</p>
<p><img class="image image-block image-center" src="images/1740691682462.png" alt="Setting AttributeRenamer parameters" width="855" height="330" /></p>
<p>Click&nbsp;<strong>OK,</strong> Run To This on the AttributeRenamer, and inspect to confirm you now have an Elevation attribute.</p>
<p><img class="image image-block image-center" src="images/1612481651315.png" alt="Inspecting AttributeRenamer output" /></p>
<blockquote>
<p><img class="img mtm" role="presentation" src="images/safe_note.png" alt="Note" /></p>
<p><span style="font-family: inherit; font-size: 1em;">You can read more about exposing list attributes&nbsp;</span><a style="font-family: inherit; font-size: 1em; background-color: #ffffff;" href="https://docs.safe.com/fme/html/FME-Form-Documentation/FME-Form/!List_Attributes/Exposing-List-Attributes.htm" target="_blank" rel="noopener">here</a><span style="font-family: inherit; font-size: 1em;">.</span></p>
</blockquote>
<h2 id="10-connect-attribute-manager">10) Connect AttributeManager</h2>
<p>Now that our points have both a distance and an elevation value, we can assign them to a flood risk zone, 1-5. We'll do this according to the table at the start of the exercise.</p>
<p>The transformer we will use is an AttributeManager. Because this lesson's focus is spatial analysis, not attribute manipulation, we've provided this transformer in the starting workspace and already configured it using Conditional Values. Connect the AttributeManager transformer to the AttributeRenamer.&nbsp;</p>
<p><img class="image image-block image-center" src="images/1740692083192.png" alt="Connecting an AttributeManager" width="751" height="127" /></p>
<p>Then, open the AttributeManager parameters. Find the FloodRisk attribute:</p>
<p><img class="image image-block image-center" src="images/1740692260445.png" alt="Finding the FloodRisk attribute in the AttributeManager parameters" width="742" height="225" /></p>
<p>We've already filled out the dialog with a series of Test Conditions, viewable by clicking the 6 Possible Values &gt; ellipsis [. . .] button. These tests will provide a value to FloodRisk 1-5 based on the combination of Zone and Elevation. These Conditional Values translate the table above into a form FME can understand.</p>
<p><img class="image image-block image-center" src="images/1612292209637.png" alt="Looking at the already-established Condition Statements in the AttributeManager" /></p>
<p>You can click&nbsp;<strong>Cancel</strong> to exit these dialogs as they are already configured and ready to use.</p>
<blockquote>
<p><img class="img mtm" role="presentation" src="images/safe_note.png" alt="Note" /></p>
<p><span style="font-family: inherit; font-size: 1em;">The&nbsp;</span><a style="font-family: inherit; font-size: 1em; background-color: #ffffff;" href="https://academy.safe.com/use-conditional-values" target="_blank" rel="noopener">Use Conditional Values</a><span style="font-family: inherit; font-size: 1em;"> course can show you how to set up dialogs like this.</span></p>
</blockquote>
<h2 id="11-add-inspector">11) Add Inspector</h2>
<p>Inspecting cached data doesn't allow you to quickly inspect your data grouped by an attribute unless you use an Inspector transformer. So, place a single Inspector transformer and connect it to the AttributeManager output.</p>
<p>Open the Inspector parameters dialog, and under Group By, select the newly created attribute called FloodRisk.</p>
<p><img class="image image-block image-center" src="images/1740692574100.png" alt="Inspector with Group By on FloodRisk" width="485" height="377" /></p>
<p>Save and run the workspace. You should see each address colored to match its flood risk. You can&nbsp;<a href="https://docs.safe.com/fme/html/FME-Form-Documentation/FME-Form/DataInspector/Display-Control.htm" target="_blank" rel="noopener">adjust the feature symbology</a>&nbsp;to produce a clearer result, like so:</p>
<p><img class="image image-block image-center" src="images/1740692763307.png" alt="Inspecting points colored to indicate their flood risk zone" width="882" height="439" /></p>
<p>You can also turn off zones one at a time to see which addresses are the most or least at risk.</p>